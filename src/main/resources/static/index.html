<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸–å­åˆ—è¡¨</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 15px;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { 
            text-align: center; 
            margin-bottom: 15px; 
            color: #333;
            font-size: 24px;
        }

        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            background: white;
        }
        .search-box input:focus {
            outline: none;
            border-color: #007bff;
        }
        .search-box button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            white-space: nowrap;
            -webkit-appearance: none;
        }
        .search-box button:active { background: #0056b3; }

        .post-list { list-style: none; }
        .post-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .post-item a {
            text-decoration: none;
            color: #333;
            display: block;
        }
        .post-item a:active { opacity: 0.7; }
        .post-content {
            font-size: 15px;
            color: #444;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        .post-date {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .no-results {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading-more {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 14px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            body { padding: 10px; }
            h1 { font-size: 20px; }
            .search-box input { font-size: 14px; padding: 10px 12px; }
            .search-box button { font-size: 14px; padding: 10px 16px; }
            .post-content { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ å¸–å­åˆ—è¡¨</h1>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢å†…å®¹..." />
            <button onclick="search()">æœç´¢</button>
        </div>
        
        <div id="postList"></div>
    </div>

    <script>
        let allPosts = [];
        let commentsData = {};
        let currentPage = 0;
        // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è®¾ç½®æ¯é¡µæ•°é‡
        const PAGE_SIZE = window.innerWidth >= 768 ? 50 : 20; // ç”µè„‘ 50 æ¡ï¼Œæ‰‹æœº 20 æ¡
        let isLoading = false;
        let hasMore = true;
        let searchKeyword = '';

        async function loadData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                const data = await response.json();
                allPosts = data.posts || [];
                commentsData = data.comments || {};
                console.log('åŠ è½½æˆåŠŸï¼Œæ€»å¸–å­æ•°ï¼š' + allPosts.length);
                
                // åŠ è½½ç¬¬ä¸€é¡µ
                loadMore();
                
                // ç»‘å®šæ»šåŠ¨äº‹ä»¶
                window.addEventListener('scroll', handleScroll);
            } catch (e) {
                console.error('åŠ è½½å¤±è´¥:', e);
                document.getElementById('postList').innerHTML =
                    '<div class="no-results">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•<br/><small>' + e.message + '</small></div>';
            }
        }

        function handleScroll() {
            // è·ç¦»åº•éƒ¨ 100px æ—¶åŠ è½½æ›´å¤š
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                if (!isLoading && hasMore) {
                    loadMore();
                }
            }
        }

        function loadMore() {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            const start = currentPage * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            
            // æ ¹æ®æ˜¯å¦æœç´¢å†³å®šæ•°æ®æº
            let sourcePosts = searchKeyword ? filteredPosts : allPosts;
            
            const pagePosts = sourcePosts.slice(start, end);
            
            if (pagePosts.length === 0) {
                hasMore = false;
                removeLoadingIndicator();
                isLoading = false;
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator();
            
            // æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½æ•ˆæœï¼ˆå¯é€‰ï¼‰
            setTimeout(() => {
                appendPosts(pagePosts);
                currentPage++;
                hasMore = end < sourcePosts.length;
                removeLoadingIndicator();
                isLoading = false;
                console.log('åŠ è½½ç¬¬' + currentPage + 'é¡µï¼Œå…±' + pagePosts.length + 'æ¡');
            }, 100);
        }

        function appendPosts(posts) {
            const container = document.getElementById('postList');
            const ul = container.querySelector('.post-list') || createPostList();
            
            posts.forEach(post => {
                const commentCount = (commentsData[post.id] || []).length;
                const li = document.createElement('li');
                li.className = 'post-item';
                li.innerHTML = `
                    <a href="post.html?id=${post.id}">
                        <div class="post-content">${escapeHtml(abbreviate(post.content, 120))}</div>
                        <div class="post-date">${formatDate(post.createdAt)} Â· ${commentCount}æ¡è¯„è®º</div>
                    </a>
                `;
                ul.appendChild(li);
            });
            
            if (!container.contains(ul)) {
                container.appendChild(ul);
            }
        }

        function createPostList() {
            const ul = document.createElement('ul');
            ul.className = 'post-list';
            return ul;
        }

        function showLoadingIndicator() {
            const container = document.getElementById('postList');
            if (!container.querySelector('.loading-more')) {
                const div = document.createElement('div');
                div.className = 'loading-more';
                div.textContent = 'åŠ è½½ä¸­...';
                container.appendChild(div);
            }
        }

        function removeLoadingIndicator() {
            const loading = document.getElementById('postList').querySelector('.loading-more');
            if (loading) loading.remove();
        }

        // æœç´¢ç»“æœçš„ä¸´æ—¶å­˜å‚¨
        let filteredPosts = [];

        function search() {
            const input = document.getElementById('searchInput');
            const kw = (input.value || '').trim();
            
            // ç©ºæœç´¢æ˜¾ç¤ºå…¨éƒ¨
            if (!kw) {
                searchKeyword = '';
                filteredPosts = [];
                resetPostList();
                currentPage = 0;
                hasMore = true;
                loadMore();
                return;
            }
            
            // ä½¿ç”¨æ›´å…¼å®¹çš„æœç´¢æ–¹å¼
            const searchLower = kw.toLowerCase();
            filteredPosts = allPosts.filter(post => {
                const content = post.content || '';
                return content.toLowerCase().indexOf(searchLower) !== -1;
            });
            
            searchKeyword = kw;
            console.log('æœç´¢å…³é”®è¯ï¼š"'+kw+'", ç»“æœï¼š'+filteredPosts.length+'æ¡');
            
            // é‡ç½®åˆ—è¡¨å¹¶åŠ è½½æœç´¢ç»“æœ
            resetPostList();
            currentPage = 0;
            hasMore = true;
            loadMore();
        }

        function resetPostList() {
            const container = document.getElementById('postList');
            container.innerHTML = '';
        }

        // æ”¯æŒå›è½¦æœç´¢
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    search();
                }
            });
        }

        function abbreviate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadData);
        } else {
            loadData();
        }
    </script>
</body>
</html>
